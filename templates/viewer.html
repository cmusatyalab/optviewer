<!doctype html>
<title>Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-1.7.2.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.mousewheel.js') }}"></script>
<style type="text/css">
body { padding: 0; margin: 0; }
html, body, .mainview { height: 100%; }
.mainview {
        position: relative;
        overflow: hidden;
}
.mainview img#main {
        display: block;
        margin-left: auto;
        margin-right: auto;
        -moz-transform-origin: 50% 50%;
        -webkit-transform-origin: 50% 50%;
        -o-transform-origin: 50% 50%;
        -ms-transform-origin: 50% 50%;
        transform-origin: 50% 50%;
}
.overlay {
        position: absolute;
        z-index: 1;
        background-color: rgba(240, 240, 240, 0.75);
        margin: 5px;
        padding: 5px;
        -moz-border-radius: 4px;
        -webkit-border-radius: 4px;
        border-radius: 4px;
}
.active {
        background-color: #7af;
}
.active .overlay {
        background-color: #fff;
}
#frame {
        top: 0px;
        right: 0px;
}
#planes {
        float: left;
        position: relative;
        height: 100%;
        margin: 0px;
        padding: 0px;
        background-color: #ccc;
        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
}
#planes h2 {
        text-align: center;
        margin: 5px;
}
#planes ul {
        list-style: none;
        margin: 0px;
        padding: 5px;
}
#planes li {
        position: relative;
        padding: 5px;
        height: 256px;
}
#bookmarks {
        float: right;
        height: 100%;
        padding: 0px;
        margin: 0px;
        background: #ccc;
        overflow-x: hidden;
        overflow-y: scroll;
        -webkit-overflow-scrolling: touch;
}
#bookmarks ul {
        list-style: none;
        margin: 0px;
        padding: 5px;
}
img.reticle {
        position: absolute;
        z-index: 2;
        top: -27px;
        left: -27px;
}
</style>
<div id="planes">
<h2>{{ Name }}</h2>
<ul>
<li class="active">
<span class='overlay'>Sagittal</span>
<img class="view" data-plane='sagittal' width="256" height="256">
<img class="reticle" src="{{ url_for('static', filename='images/reticle.png') }}">
<li>
<span class='overlay'>Coronal</span>
<img class="view" data-plane='coronal' width="256" height="256">
<img class="reticle" src="{{ url_for('static', filename='images/reticle.png') }}">
<li>
<span class='overlay'>Transverse</span>
<img class="view" data-plane='transverse' width="256" height="256">
<img class="reticle" src="{{ url_for('static', filename='images/reticle.png') }}">
</ul>
</div>
<div id="bookmarks">
<ul>
{% for frame in keyframes %}
<li>
<img class="view" width="128" height="128" data-frame="{{ frame }}">
{% endfor %}
</ul>
</div>
<div class="mainview">
<div class="overlay" id="frame"></div>
<img class="view" id="main">
</div>
<script type="text/javascript">
//
// OPT viewer
//
// Copyright (c) 2012 Carnegie Mellon University
//
// This code is distributed "AS IS" without warranty of any kind under
// the terms of the GNU General Public Licence Version 2.
//
// http://www.gnu.org/licenses/gpl-2.0.html
//
var optview = {
    url: "{{ url_for('image') }}",
    edgeLength: {{ nFrames }},

    SCALE_FACTOR: 1.25,
    SCROLL_SPEED: 10,

    plane: "sagittal",

    sagittal: 0,
    coronal: 0,
    transverse: 0,

    transformX: 0,
    transformY: 0,
    transformZ: 1,
};

optview.imgPlane = function ($img) {
    var plane = $img.data('plane');
    return typeof plane === 'string' ? plane : this.plane;
};
optview.imgFrame = function ($img) {
    var frame = $img.data('frame');
    if (typeof frame !== 'number') {
        var plane = this.imgPlane($img);
        frame = this[plane];
    }
    return parseInt(frame);
};

function optview_reload_cb() {
    var $this = $(this);

    if ($this.prop('loading')) { return; }

    var plane = optview.imgPlane($this);
    var frame = optview.imgFrame($this);
    var image_url = optview.url.replace(/PLANE/g, plane).
                                replace(/FRAME/g, frame);

    $this.prop('loading', true);
    $("<img />").bind("load", function () {
        $this.hide().attr("src", image_url).show().prop('loading', false);

        if ($this.attr('id') === 'main') {
            $("#frame").text('Frame: ' + frame);
            var $img = $('#planes img[data-plane='+plane+']');
            $img.hide().attr("src", image_url).show()
        }

        if (frame != optview.imgFrame($this)) {
            $this.each(optview_reload_cb);
        }
    }).attr("src", image_url);
};

optview.update_plane = function (plane) {
    if (!plane || this.plane === plane) { return; }

    this.plane = plane;

    $('#planes li').removeClass('active');
    $('#planes img[data-plane='+plane+']').closest('li').addClass('active');

    $('img#main').each(optview_reload_cb);
    $('#bookmarks img').each(optview_reload_cb);
};
optview.update_reticle = function (plane, x, y) {
    var style = 'translate('+(x/2)+'px,'+((512-y)/2)+'px)';
    $("#planes img[data-plane="+plane+"]").next("img.reticle").css({
        '-moz-transform': style,
        '-webkit-transform': style,
        '-o-transform': style,
        '-ms-transform': style,
        'transform': style
    });
};
optview.update_transform = function () {
    var style = 'translate('+this.transformX+'px,'+this.transformY+'px) scale('+this.transformZ+')';
    $("img#main").css({
        '-moz-transform': style,
        '-webkit-transform': style,
        '-o-transform': style,
        '-ms-transform': style,
        'transform': style
    });
};
optview.update_frame = function (plane, frame) {

    var frame = Math.max(0, Math.min(this.edgeLength - 1, frame));
    if (this[plane] === frame) { return; }

    this[plane] = frame;

    if (plane === this.plane) {
        $('img#main').each(optview_reload_cb);
    } else {
        $('#planes img[data-plane='+plane+']').each(optview_reload_cb);
    }
    this.update_reticle('sagittal', this.transverse, this.coronal);
    this.update_reticle('coronal', this.sagittal, this.transverse);
    this.update_reticle('transverse', this.sagittal, this.coronal);
};

optview.move = function (X, Y) {
    this.transformX += X;
    this.transformY += Y;
    this.update_transform();
};
optview.zoom = function (direction, altPressed) {
    if (!altPressed) {
        var plane = optview.plane;
        var frame = optview[plane] + direction;
        this.update_frame(plane, frame);
    } else {
        var scale = Math.pow(this.SCALE_FACTOR, direction);
        this.transformX *= scale;
        this.transformY *= scale;
        this.transformZ *= scale;
        this.update_transform();
    }
};

$(function () {
    optview.update_frame('sagittal', optview.edgeLength / 2);
    optview.update_frame('coronal', optview.edgeLength / 2);
    optview.update_frame('transverse', optview.edgeLength / 2);
    $('#bookmarks img.view').each(optview_reload_cb);

    $("#planes li").click(function (ev) {
        var plane = $(this).find('img[data-plane]').data('plane');
        optview.update_plane(plane);
    });

    $('#bookmarks img').click(function () {
        var frame = $(this).data('frame');
        optview.update_frame(optview.plane, frame);
    });

    $('body').keydown(function(ev) {
        if (ev.which == 37) {           // left
            ev.preventDefault();
            optview.move(-optview.SCROLL_SPEED, 0);
        } else if (ev.which == 38) {    // up
            ev.preventDefault();
            optview.move(0, -optview.SCROLL_SPEED);
        } else if (ev.which == 39) {    // right
            ev.preventDefault();
            optview.move(optview.SCROLL_SPEED, 0);
        } else if (ev.which == 40) {    // down
            ev.preventDefault();
            optview.move(0, optview.SCROLL_SPEED);
        } else if (ev.which == 33) {    // page up
            ev.preventDefault();
            optview.zoom(1, ev.altKey);
        } else if (ev.which == 34) {    // page down
            ev.preventDefault();
            optview.zoom(-1, ev.altKey);
        }
    });
    $("img#main").mousedown(function (ev) {
        var lastX = ev.pageX, lastY = ev.pageY;
        var moved = false;
        ev.preventDefault();
        $(document).mousemove(function (ev) {
            ev.preventDefault();
            moved = true;
            optview.move(ev.pageX - lastX, ev.pageY - lastY);
            lastX = ev.pageX;
            lastY = ev.pageY;
        }).mouseup(function (ev) {
            ev.preventDefault();
            if (!moved && ev.target instanceof HTMLImageElement) {
                var x = ev.offsetX, y = ev.target.height - ev.offsetY - 1;
                if (optview.plane === 'sagittal') {
                    optview.update_frame('transverse', x);
                    optview.update_frame('coronal', y);
                } else if (optview.plane === 'coronal') {
                    optview.update_frame('sagittal', x);
                    optview.update_frame('transverse', y);
                } else if (optview.plane === 'transverse') {
                    optview.update_frame('sagittal', x);
                    optview.update_frame('coronal', y);
                }
            }
            $(document).unbind('mousemove');
            $(document).unbind('mouseup');
        });
    });
    $(".mainview").mousewheel(function (ev, delta, deltaX, deltaY) {
        optview.zoom(deltaY, ev.altKey);
    });
});
</script>

