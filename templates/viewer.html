<!doctype html>
<title>Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-1.7.2.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.mousewheel.js') }}"></script>
<style type="text/css">
body { padding: 0; margin: 0; }
html, body, #map { height: 100%; }
.bookmarks {
        position: relative;
        top: -175px;
        height: 175px;
        z-index: 1;
        width: 100%;
        background: #ccc;
        overflow-x: scroll;
        overflow-y: hidden;
        //overflow: auto;
        -webkit-overflow-scrolling: touch;
}
.bookmarks ul {
        list-style: none;
        padding: 0px;
        margin: 0px;
        margin-top: 20px;
        display: block;
        white-space: nowrap;
}
.bookmarks li { display: inline; }
.bookmarks img {
        padding: 5px;
        -moz-border-radius: 4px;
        -webkit-border-radius: 4px;
        border-radius: 4px;
        width: 128px;
        height: 128px;
}
#map {
        overflow: hidden;
}
#map img {
        display: block;
        margin-left: auto;
        margin-right: auto;
        -moz-transform-origin: 50% 50%;
        -webkit-transform-origin: 50% 50%;
        -o-transform-origin: 50% 50%;
        -ms-transform-origin: 50% 50%;
        transform-origin: 50% 50%;
}
#frame {
        z-index: 1;
        background-color: rgba(255, 255, 255, 0.75);
        margin: 5px;
        padding: 5px;
        -moz-border-radius: 4px;
        -webkit-border-radius: 4px;
        border-radius: 4px;

        position: absolute;
        right: 30%;
}
</style>
<div id="map">
<div id="frame"></div>
<img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
</div>
<div class="bookmarks">
<ul>
{% for frame in keyframes %}
<li><img data-frame="{{ frame }}" width="128" height="128" src="{{ url_for('tile', frame=frame) }}"></li>
{% endfor %}
</ul>
</div>
<script type="text/javascript">
var tile_url = "{{ url_for('tile') }}{frame}.png";
var SCALE_FACTOR = {{ SCALE_FACTOR }};
var SCROLL_SPEED = {{ SCROLL_SPEED }};

var loading = -1;
var currentFrame = {{ nFrames / 2 }};
var transformX = 0, transformY = 0, transformS = 1;

function set_currentframe(frame) {
    currentFrame = Math.max(0, Math.min({{ nFrames }} - 1, frame))
    if (loading != -1) { return; }

    loading = currentFrame;
    var image_url = tile_url.replace(/\{frame\}/g, loading);

    $("<img />").bind("load", function () {
        $("#frame").text(loading);
        loading = -1;
        $("#map img").hide().attr("src", image_url).show();
    }).attr("src", image_url);
};

function update_transform() {
    //var style = 'translate('+transformX+'px,'+transformY+'px) scale('+transformS+')';
    var style = 'translate('+transformX+'px,'+transformY+'px) scale('+transformS+')';
    $("#map img").css({
        '-moz-transform': style,
        '-webkit-transform': style,
        '-o-transform': style,
        '-ms-transform': style,
        'transform': style
    });
};

$(function () {
    set_currentframe(currentFrame);

    $('div.bookmarks img').click(function () {
        var frame = $(this).attr('data-frame');
        set_currentframe(parseInt(frame));
    });

    $('body').keydown(function(ev) {
        if (ev.which == 37) {           // left
            ev.preventDefault();
            transformX -= SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 38) {    // up
            ev.preventDefault();
            transformY -= SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 39) {    // right
            ev.preventDefault();
            transformX += SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 40) {    // down
            ev.preventDefault();
            transformY += SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 33) {    // page up
            ev.preventDefault();
            if (ev.altKey) {
                set_currentframe(currentFrame + 1);
            } else {
                transformX *= SCALE_FACTOR;
                transformY *= SCALE_FACTOR;
                transformS *= SCALE_FACTOR;
                update_transform();
            }
        } else if (ev.which == 34) {    // page down
            ev.preventDefault();
            if (ev.altKey) {
                set_currentframe(currentFrame - 1);
            } else {
                transformX /= SCALE_FACTOR;
                transformY /= SCALE_FACTOR;
                transformS /= SCALE_FACTOR;
                update_transform();
            }
        } else {
            //alert('keydown '+ev.which);
        }
    }).mouseup(function (ev) {
        $('#map').unbind('mousemove');
    });
    $("#map").mousedown(function (ev) {
        if (ev.button == 0) {
            var lastX = ev.pageX, lastY = ev.pageY;
            ev.preventDefault();
            $(this).mousemove(function (ev) {
                ev.preventDefault();
                transformX += ev.pageX - lastX;
                transformY += ev.pageY - lastY;
                lastX = ev.pageX;
                lastY = ev.pageY;
                update_transform();
            });
        }
    }).mousewheel(function (ev, delta, deltaX, deltaY) {
        //console.log(delta, deltaX, deltaY);
        if (ev.altKey) {
            set_currentframe(currentFrame + delta);
        } else if (delta > 0) {
            transformX *= SCALE_FACTOR;
            transformY *= SCALE_FACTOR;
            transformS *= SCALE_FACTOR;
            update_transform();
        } else {
            transformX /= SCALE_FACTOR;
            transformY /= SCALE_FACTOR;
            transformS /= SCALE_FACTOR;
            update_transform();
        }
    });
});
</script>

