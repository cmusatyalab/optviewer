<!doctype html>
<title>Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-1.7.2.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.mousewheel.js') }}"></script>
<style type="text/css">
body { padding: 0; margin: 0; }
html, body, #map { height: 100%; }
#map {
        position: relative;
        overflow: hidden;
}
#map img {
        display: block;
        margin-left: auto;
        margin-right: auto;
        -moz-transform-origin: 50% 50%;
        -webkit-transform-origin: 50% 50%;
        -o-transform-origin: 50% 50%;
        -ms-transform-origin: 50% 50%;
        transform-origin: 50% 50%;
}
.overlay {
        position: absolute;
        z-index: 1;
        background-color: rgba(240, 240, 240, 0.75);
        margin: 5px;
        padding: 5px;
        -moz-border-radius: 4px;
        -webkit-border-radius: 4px;
        border-radius: 4px;
}
#frame {
        top: 0px;
        right: 0px;
}

#planes {
        float: left;
        position: relative;
        height: 100%;
        margin: 0px;
        padding: 0px;
        background: #ccc;
        overflow: hidden;
}
#planes ul {
        list-style: none;
        margin: 0px;
        padding: 5px;
}
#bookmarks {
        float: right;
        height: 100%;
        padding: 0px;
        margin: 0px;
        background: #ccc;
        overflow-x: hidden;
        overflow-y: scroll;
        -webkit-overflow-scrolling: touch;
}
#bookmarks ul {
        list-style: none;
        margin: 0px;
        padding: 5px;
}
</style>
<div id="planes">
<ul>
<li>
<span class='overlay'>Sagittal</span>
<img width="256" height="256" data-plane="1" data-frame="256"
     src="{{ url_for('tile', plane=1, frame=256) }}" />
</li>
<li>
<span class='overlay'>Coronal</span>
<img width="256" height="256" data-plane="2" data-frame="256"
     src="{{ url_for('tile', plane=2, frame=256) }}" />
</li>
<li>
<span class='overlay'>Transverse</span>
<img width="256" height="256" data-plane="3" data-frame="256"
     src="{{ url_for('tile', plane=3, frame=256) }}" />
</li>
</ul>
</div>
<div id="bookmarks">
<ul>
{% for frame in keyframes %}
<li>
<img width="128" height="128" data-plane=1 data-frame="{{ frame }}"
     src="{{ url_for('tile', plane=1, frame=frame) }}">
</li>
{% endfor %}
</ul>
</div>
<div id="map">
<div class="overlay" id="frame"></div>
<img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
</div>
<script type="text/javascript">
var tile_url = "{{ url_for('tile') }}";
var SCALE_FACTOR = {{ SCALE_FACTOR }};
var SCROLL_SPEED = {{ SCROLL_SPEED }};

var currentPlane = 1;
var currentFrame = parseInt({{ nFrames / 2 }});
var transformX = 0, transformY = 0, transformS = 1;

var $planes = $("#planes img")

function update_plane(plane, val) {
    var $img = $($planes[plane - 1]);
    val = Math.max(0, Math.min({{ nFrames - 1 }}, val));

    if ($img.prop('loading')) { return; }

    var image_url = tile_url.replace(/PLANE/g, plane)
                            .replace(/FRAME/g, val);

    $img.prop('loading', true);
    $("<img />").bind("load", function () {
        $img.hide().attr("src", image_url).show()
            .data('frame', val).prop('loading', false);

        if (plane == currentPlane) {
            $("#frame").text('Frame: ' + val);
            $("#map img").hide().attr("src", image_url).show()
                         .data('frame', val);
        }
    }).attr("src", image_url);
}

function redraw() {
    update_plane(currentPlane, currentFrame);
}

function set_currentframe(frame) {
    currentFrame = Math.max(0, Math.min({{ nFrames - 1 }}, frame))
    redraw();
};

function update_transform() {
    //var style = 'translate('+transformX+'px,'+transformY+'px) scale('+transformS+')';
    var style = 'translate('+transformX+'px,'+transformY+'px) scale('+transformS+')';
    $("#map img").css({
        '-moz-transform': style,
        '-webkit-transform': style,
        '-o-transform': style,
        '-ms-transform': style,
        'transform': style
    });
};

function zoom(direction, alternate)
{
    if (!alternate) {
        set_currentframe(currentFrame + direction);
        return;
    }
    if (direction > 0) {
        transformX *= SCALE_FACTOR;
        transformY *= SCALE_FACTOR;
        transformS *= SCALE_FACTOR;
    } else {
        transformX /= SCALE_FACTOR;
        transformY /= SCALE_FACTOR;
        transformS /= SCALE_FACTOR;
    }
    update_transform();
}

$(function () {
    redraw();

    $("#planes li").click(function (ev) {
        $img = $(this).children('img');
        currentPlane = $img.data('plane');
        currentFrame = $img.data('frame');
        redraw();
    });

    $('#bookmarks img').click(function () {
        var frame = $(this).data('frame');
        set_currentframe(parseInt(frame));
    });

    $('body').keydown(function(ev) {
        if (ev.which == 37) {           // left
            ev.preventDefault();
            transformX -= SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 38) {    // up
            ev.preventDefault();
            transformY -= SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 39) {    // right
            ev.preventDefault();
            transformX += SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 40) {    // down
            ev.preventDefault();
            transformY += SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 33) {    // page up
            ev.preventDefault();
            zoom(1, ev.altKey);
        } else if (ev.which == 34) {    // page down
            ev.preventDefault();
            zoom(-1, ev.altKey);
        }
    }).mouseup(function (ev) {
        $('#map').unbind('mousemove');
    });
    $("#map").mousedown(function (ev) {
        var lastX = ev.pageX, lastY = ev.pageY;
        ev.preventDefault();

        if (ev.target instanceof HTMLImageElement) {
            var x = ev.offsetX, y = ev.target.height - ev.offsetY - 1;
            if (currentPlane == 1) {
                update_plane(3, x);
                update_plane(2, y);
            } else if (currentPlane == 2) {
                update_plane(1, x);
                update_plane(3, y);
            } else if (currentPlane == 3) {
                update_plane(1, x);
                update_plane(2, y);
            }
        }

        $("#map").mousemove(function (ev) {
            ev.preventDefault();
            transformX += ev.pageX - lastX;
            transformY += ev.pageY - lastY;
            lastX = ev.pageX;
            lastY = ev.pageY;
            update_transform();
        });
    });
    $("#map").mousewheel(function (ev, delta, deltaX, deltaY) {
        //console.log(delta, deltaX, deltaY);
        if (deltaX != 0) {
            zoom(deltaX, true);
        } else {
            zoom(deltaY, ev.altKey);
        }
    });
});
</script>

