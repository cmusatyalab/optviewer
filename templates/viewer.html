<!doctype html>
<title>Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-1.7.2.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.mousewheel.js') }}"></script>
<style type="text/css">
body { padding: 0; margin: 0; }
html, body, #map { height: 100%; }
#map {
        position: relative;
        overflow: hidden;
}
#map img#main {
        display: block;
        margin-left: auto;
        margin-right: auto;
        -moz-transform-origin: 50% 50%;
        -webkit-transform-origin: 50% 50%;
        -o-transform-origin: 50% 50%;
        -ms-transform-origin: 50% 50%;
        transform-origin: 50% 50%;
}
.overlay {
        position: absolute;
        z-index: 1;
        background-color: rgba(240, 240, 240, 0.75);
        margin: 5px;
        padding: 5px;
        -moz-border-radius: 4px;
        -webkit-border-radius: 4px;
        border-radius: 4px;
}
#frame {
        top: 0px;
        right: 0px;
}

#planes {
        float: left;
        position: relative;
        height: 100%;
        margin: 0px;
        padding: 0px;
        background: #ccc;
        overflow: hidden;
}
#planes ul {
        list-style: none;
        margin: 0px;
        padding: 5px;
}
#bookmarks {
        float: right;
        height: 100%;
        padding: 0px;
        margin: 0px;
        background: #ccc;
        overflow-x: hidden;
        overflow-y: scroll;
        -webkit-overflow-scrolling: touch;
}
#bookmarks ul {
        list-style: none;
        margin: 0px;
        padding: 5px;
}
</style>
<div id="planes">
<ul>
<li>
<span class='overlay'>Sagittal</span>
<img data-plane='sagittal' data-frame="{{ nFrames / 2 }}"
     width="256" height="256"
     src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
</li>
<li>
<span class='overlay'>Coronal</span>
<img data-plane='coronal' data-frame="{{ nFrames / 2 }}"
     width="256" height="256"
     src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
</li>
<li>
<span class='overlay'>Transverse</span>
<img data-plane='transverse' data-frame="{{ nFrames / 2 }}"
     width="256" height="256"
     src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
</li>
</ul>
</div>
<div id="map" data-plane="sagittal">
<div id="bookmarks">
<ul>
{% for frame in keyframes %}
<li>
<img width="128" height="128" data-frame="{{ frame }}"
     src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
</li>
{% endfor %}
</ul>
</div>
<div class="overlay" id="frame"></div>
<img id="main"
     src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
</div>
<script type="text/javascript">
var tile_url = "{{ url_for('tile') }}";
var SCALE_FACTOR = {{ SCALE_FACTOR }};
var SCROLL_SPEED = {{ SCROLL_SPEED }};

function reload() {
    var $this = $(this);

    if ($this.prop('loading')) { return; }

    var plane = $this.closest('[data-plane]').data('plane');
    var frame = $this.data('frame');
    var image_url = tile_url.replace(/PLANE/g, plane).replace(/FRAME/g, frame);

    $this.prop('loading', true);
    $("<img />").bind("load", function () {
        $this.hide().attr("src", image_url).show().prop('loading', false);
        //if (frame != currentFrame()) {
        //    $this.each(reload);
        //    return;
        //}

        if (plane == currentPlane()) {
            $("#frame").text('Frame: ' + frame);
            $("img#main").hide().attr("src", image_url).show();
        }
    }).attr("src", image_url);
}

function currentPlane() {
    return $('#map').data('plane');
}

function currentFrame() {
    var plane = currentPlane();
    var $img = $('#planes img[data-plane='+plane+']');
    var frame = $img.data('frame');
    return parseInt(frame);
}

function set_currentPlane(plane, frame) {
    if (plane != currentPlane()) {
        $('#map').data('plane', plane);
        $('#bookmarks img').each(reload);
        $('#planes img[data-plane='+plane+']').data('frame',frame).each(reload);
    }
}

var transformX = 0, transformY = 0, transformS = 1;

function update_plane(plane, frame) {
    var frame = Math.max(0, Math.min({{ nFrames - 1 }}, frame));
    var $img = $('#planes img[data-plane='+plane+']')

    if (frame != $img.data('frame')) {
        $img.data('frame', frame).each(reload);
    }
}

function update_transform() {
    var style = 'translate('+transformX+'px,'+transformY+'px) scale('+transformS+')';
    $("#map img#main").css({
        '-moz-transform': style,
        '-webkit-transform': style,
        '-o-transform': style,
        '-ms-transform': style,
        'transform': style
    });
};

function zoom(direction, alternate)
{
    if (!alternate) {
        update_plane(currentPlane(), currentFrame() + direction);
        return;
    }
    if (direction > 0) {
        transformX *= SCALE_FACTOR;
        transformY *= SCALE_FACTOR;
        transformS *= SCALE_FACTOR;
    } else {
        transformX /= SCALE_FACTOR;
        transformY /= SCALE_FACTOR;
        transformS /= SCALE_FACTOR;
    }
    update_transform();
}

$(function () {
    $('img[data-frame]').each(reload);

    $("#planes li").click(function (ev) {
        $img = $(this).children('img');
        set_currentPlane($img.data('plane'), $img.data('frame'));
    });

    $('#bookmarks img').click(function () {
        var frame = $(this).data('frame');
        update_plane(currentPlane(), frame);
    });

    $('body').keydown(function(ev) {
        if (ev.which == 37) {           // left
            ev.preventDefault();
            transformX -= SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 38) {    // up
            ev.preventDefault();
            transformY -= SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 39) {    // right
            ev.preventDefault();
            transformX += SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 40) {    // down
            ev.preventDefault();
            transformY += SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 33) {    // page up
            ev.preventDefault();
            zoom(1, ev.altKey);
        } else if (ev.which == 34) {    // page down
            ev.preventDefault();
            zoom(-1, ev.altKey);
        }
    }).mouseup(function (ev) {
        $('#map').unbind('mousemove');
    });
    $("img#main").mousedown(function (ev) {
        var lastX = ev.pageX, lastY = ev.pageY;
        ev.preventDefault();

        if (ev.target instanceof HTMLImageElement) {
            var x = ev.offsetX, y = ev.target.height - ev.offsetY - 1;
            if (currentPlane() == 'sagittal') {
                update_plane('transverse', x);
                update_plane('coronal', y);
            } else if (currentPlane() == 'coronal') {
                update_plane('sagittal', x);
                update_plane('transverse', y);
            } else if (currentPlane() == 'transverse') {
                update_plane('sagittal', x);
                update_plane('coronal', y);
            }
        }

        $("#map").mousemove(function (ev) {
            ev.preventDefault();
            transformX += ev.pageX - lastX;
            transformY += ev.pageY - lastY;
            lastX = ev.pageX;
            lastY = ev.pageY;
            update_transform();
        });
    });
    $("img#main").mousewheel(function (ev, delta, deltaX, deltaY) {
        //console.log(delta, deltaX, deltaY);
        if (deltaX != 0) {
            zoom(deltaX, true);
        } else {
            zoom(deltaY, ev.altKey);
        }
    });
});
</script>

