<!doctype html>
<title>Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-1.7.2.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery.mousewheel.js') }}"></script>
<style type="text/css">
body { padding: 0; margin: 0; }
html, body, #map { height: 100%; }
#map {
        position: relative;
        overflow: hidden;
}
#map img#main {
        display: block;
        margin-left: auto;
        margin-right: auto;
        -moz-transform-origin: 50% 50%;
        -webkit-transform-origin: 50% 50%;
        -o-transform-origin: 50% 50%;
        -ms-transform-origin: 50% 50%;
        transform-origin: 50% 50%;
}
.overlay {
        position: absolute;
        z-index: 1;
        background-color: rgba(240, 240, 240, 0.75);
        margin: 5px;
        padding: 5px;
        -moz-border-radius: 4px;
        -webkit-border-radius: 4px;
        border-radius: 4px;
}
.active, .active .overlay {
        background-color: #fff;
}
#frame {
        top: 0px;
        right: 0px;
}
#planes {
        float: left;
        position: relative;
        height: 100%;
        margin: 0px;
        padding: 0px;
        background-color: #ccc;
        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
}
#planes ul {
        list-style: none;
        margin: 0px;
        padding: 5px;
}
#planes li {
        padding: 5px;
        height: 256px;
}
#bookmarks {
        float: right;
        height: 100%;
        padding: 0px;
        margin: 0px;
        background: #ccc;
        overflow-x: hidden;
        overflow-y: scroll;
        -webkit-overflow-scrolling: touch;
}
#bookmarks ul {
        list-style: none;
        margin: 0px;
        padding: 5px;
}
</style>
<div id="planes">
<ul>
<li class="active">
<span class='overlay'>Sagittal</span>
<img data-plane='sagittal' width="256" height="256"
     src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
</li>
<li>
<span class='overlay'>Coronal</span>
<img data-plane='coronal' width="256" height="256"
     src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
</li>
<li>
<span class='overlay'>Transverse</span>
<img data-plane='transverse' width="256" height="256"
     src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
</li>
</ul>
</div>
<div id="bookmarks">
<ul>
{% for frame in keyframes %}
<li>
<img width="128" height="128" data-frame="{{ frame }}"
     src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
</li>
{% endfor %}
</ul>
</div>
<div id="map">
<div class="overlay" id="frame"></div>
<img id="main" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
</div>
<script type="text/javascript">
var tile_url = "{{ url_for('tile') }}";
var SCALE_FACTOR = {{ SCALE_FACTOR }};
var SCROLL_SPEED = {{ SCROLL_SPEED }};

var currentPlane = 'sagittal';
var currentFrame = {
    sagittal: {{ nFrames // 2 }},
    coronal: {{ nFrames // 2 }},
    transverse: {{ nFrames // 2 }},
};
var transformX = 0, transformY = 0, transformZ = 1;

function thisPlane($this) {
    var plane = $this.data('plane');
    return typeof plane === 'string' ? plane : currentPlane;
}

function thisFrame($this, plane) {
    var frame = $this.data('frame');
    return typeof frame === 'number' ? frame : currentFrame[plane];
}

function reload() {
    var $this = $(this);

    if ($this.prop('loading')) { return; }

    var plane = thisPlane($this);
    var frame = thisFrame($this, plane);
    var image_url = tile_url.replace(/PLANE/g, plane).replace(/FRAME/g, frame);

    $this.prop('loading', true);
    $("<img />").bind("load", function () {
        $this.hide().attr("src", image_url).show().prop('loading', false);

        if ($this.attr('id') === 'main') {
            $("#frame").text('Frame: ' + frame);
            var $img = $('#planes img[data-plane='+plane+']');
            $img.hide().attr("src", image_url).show();
            $("#frame").text('Frame: ' + frame);
        }

        if (frame != thisFrame($this, plane)) {
            $this.each(reload);
        }
    }).attr("src", image_url);
}

function update_plane(plane) {
    if (currentPlane !== plane) {
        currentPlane = plane;

        $('#planes li').removeClass('active');
        $('#planes img[data-plane='+plane+']').closest('li').addClass('active');

        $('img#main').each(reload);
        $('#bookmarks img').each(reload);
    }
}

function update_frame(plane, frame) {
    var frame = Math.max(0, Math.min({{ nFrames - 1 }}, frame));

    if (currentFrame[plane] != frame) {
        currentFrame[plane] = frame;

        if (plane === currentPlane) {
            $('img#main').each(reload);
        } else {
            $('#planes img[data-plane='+plane+']').each(reload);
        }
    }
}

function update_transform() {
    var style = 'translate('+transformX+'px,'+transformY+'px) scale('+transformZ+')';
    $("img#main").css({
        '-moz-transform': style,
        '-webkit-transform': style,
        '-o-transform': style,
        '-ms-transform': style,
        'transform': style
    });
};

function zoom(direction, altPressed)
{
    if (!altPressed) {
        update_frame(currentPlane, currentFrame[currentPlane] + direction);
    } else {
        var scale = Math.pow(SCALE_FACTOR, direction);
        transformX *= scale;
        transformY *= scale;
        transformZ *= scale;
        update_transform();
    }
}

$(function () {
    $('img').each(reload);

    $("#planes li").click(function (ev) {
        var plane = $(this).children('img').data('plane');
        update_plane(plane);
    });

    $('#bookmarks img').click(function () {
        var frame = $(this).data('frame');
        update_frame(currentPlane, frame);
    });

    $('body').keydown(function(ev) {
        if (ev.which == 37) {           // left
            ev.preventDefault();
            transformX -= SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 38) {    // up
            ev.preventDefault();
            transformY -= SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 39) {    // right
            ev.preventDefault();
            transformX += SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 40) {    // down
            ev.preventDefault();
            transformY += SCROLL_SPEED;
            update_transform();
        } else if (ev.which == 33) {    // page up
            ev.preventDefault();
            zoom(1, ev.altKey);
        } else if (ev.which == 34) {    // page down
            ev.preventDefault();
            zoom(-1, ev.altKey);
        }
    });
    $("img#main").mousedown(function (ev) {
        var lastX = ev.pageX, lastY = ev.pageY;
        var moved = false;
        ev.preventDefault();
        $(document).mousemove(function (ev) {
            moved = true;
            ev.preventDefault();
            transformX += ev.pageX - lastX;
            transformY += ev.pageY - lastY;
            lastX = ev.pageX;
            lastY = ev.pageY;
            update_transform();
        }).mouseup(function (ev) {
            if (!moved && ev.target instanceof HTMLImageElement) {
                var x = ev.offsetX, y = ev.target.height - ev.offsetY - 1;
                if (currentPlane === 'sagittal') {
                    update_frame('transverse', x);
                    update_frame('coronal', y);
                } else if (currentPlane === 'coronal') {
                    update_frame('sagittal', x);
                    update_frame('transverse', y);
                } else if (currentPlane === 'transverse') {
                    update_frame('sagittal', x);
                    update_frame('coronal', y);
                }
            }

            $(document).unbind('mousemove');
            $(document).unbind('mouseup');
        });
    });
    $("#map").mousewheel(function (ev, delta, deltaX, deltaY) {
        //console.log(delta, deltaX, deltaY);
        if (deltaX != 0) {
            zoom(deltaX, true);
        } else {
            zoom(deltaY, ev.altKey);
        }
    });
});
</script>

